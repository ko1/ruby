/* DO NOT EDIT THIS FILE DIRECTLY: edit template/opt_method.inc.tmpl instead */
<%
defs = File.join(File.dirname(File.dirname(erb.filename)), "defs/opt_method.def")
eval(File.read(defs), binding, defs)
%>

static void
add_opt_method(st_table *tbl, VALUE klass, ID mid,
		enum ruby_optimized_method om)
{
    rb_method_entry_t *me = rb_method_entry_at(klass, mid);

    if (me && me->def && me->def->type == VM_METHOD_TYPE_CFUNC) {
	st_insert(tbl, (st_data_t)me, (st_data_t)om);
    }
    else if (mid != idNeq) {
	rb_bug("undefined optimized method: %s", rb_id2name(mid));
    }
}

static void
vm_init_redefined_flags(void *tbl)
{
<%
OPT_METHODS.each do |(mid, *classes)|
  classes.flatten.each do |klass|
%>
    add_opt_method(tbl, rb_c<%= klass %>, <%= mid %>, <%= om(mid, klass) %>);
<%
  end # classes.each
end # OPT_METHODS.each
%>
}

static int
vm_redefinition_check_flag(VALUE klass)
{
<% opt_classes.each_key do |klass| %>
    if (klass == rb_c<%= klass %>) return 1;
<% end %>
    return 0;
}
